/* eslint-disable no-undef */
import { precacheAndRoute } from "workbox-precaching";
import { registerRoute } from "workbox-routing";
import { StaleWhileRevalidate, CacheFirst } from "workbox-strategies";
import { ExpirationPlugin } from "workbox-expiration";

// Precache all assets generated by Vite build
precacheAndRoute(self.__WB_MANIFEST || []);

// Cache API calls (IndexedDB is already offline by design)
registerRoute(
  ({ url }) => url.origin === self.location.origin && url.pathname.endsWith(".json"),
  new StaleWhileRevalidate({
    cacheName: "api-cache",
  })
);

// Cache images
registerRoute(
  ({ request }) => request.destination === "image",
  new CacheFirst({
    cacheName: "image-cache",
    plugins: [
      new ExpirationPlugin({
        maxEntries: 50,
        maxAgeSeconds: 7 * 24 * 60 * 60, // 1 week
      }),
    ],
  })
);

// Cache CSS/JS
registerRoute(
  ({ request }) =>
    request.destination === "style" ||
    request.destination === "script" ||
    request.destination === "worker",
  new StaleWhileRevalidate({
    cacheName: "static-resources",
  })
);

// Notifications (still supported)
self.addEventListener("push", (event) => {
  const data = event.data?.json() || {};
  event.waitUntil(
    self.registration.showNotification(data.title || "Health Tracker", {
      body: data.body || "Reminder",
      icon: "/icon-192.png",
    })
  );
});
